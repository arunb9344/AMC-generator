<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Service Report Generator</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
</head>
<body class="bg-gray-100 font-sans">
    <div class="container mx-auto p-4 max-w-4xl">
        <h1 class="text-3xl font-bold text-center mb-6">Service Report Generator</h1>

        <div class="flex justify-center mb-6">
            <a href="index.html" class="px-4 py-2 bg-blue-600 text-white rounded-l-md hover:bg-blue-700">AMC Agreement</a>
            <a href="service-report-generator.html" class="px-4 py-2 bg-gray-800 text-white rounded-r-md">Service Report</a>
        </div>

        <form id="serviceReportForm" class="bg-white p-6 rounded-lg shadow-md">
            <div class="mb-6">
                <h2 class="text-xl font-semibold mb-4">Customer Details</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="customerName" class="block text-sm font-medium text-gray-700">Customer Name</label>
                        <input type="text" id="customerName" name="customerName" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2">
                    </div>
                    <div>
                        <label for="customerAddress" class="block text-sm font-medium text-gray-700">Customer Address</label>
                        <input type="text" id="customerAddress" name="customerAddress" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2">
                    </div>
                    <div>
                        <label for="contactPerson" class="block text-sm font-medium text-gray-700">Contact Person</label>
                        <input type="text" id="contactPerson" name="contactPerson" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2">
                    </div>
                    <div>
                        <label for="customerContact" class="block text-sm font-medium text-gray-700">Customer Contact Number</label>
                        <input type="tel" id="customerContact" name="customerContact" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2">
                    </div>
                    <div>
                        <label for="customerEmail" class="block text-sm font-medium text-gray-700">Customer Email</label>
                        <input type="email" id="customerEmail" name="customerEmail" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2">
                    </div>
                </div>
            </div>

            <div class="mb-6">
                <h2 class="text-xl font-semibold mb-4">Service Details</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="serviceType" class="block text-sm font-medium text-gray-700">Service Type</label>
                        <select id="serviceType" name="serviceType" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2">
                            <option value="">Select Service Type</option>
                            <option value="Maintenance Visit">Maintenance Visit</option>
                            <option value="Breakdown Visit">Breakdown Visit</option>
                        </select>
                    </div>
                    <div>
                        <label for="equipmentType" class="block text-sm font-medium text-gray-700">Equipment Type</label>
                        <select id="equipmentType" name="equipmentType" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2">
                            <option value="">Select Equipment Type</option>
                            <option value="CCTV">CCTV</option>
                            <option value="Biometrics & Access Control">Biometrics & Access Control</option>
                            <option value="Video Door Bell">Video Door Bell</option>
                            <option value="Fire Alarm">Fire Alarm</option>
                        </select>
                    </div>
                    <div>
                        <label for="serviceDate" class="block text-sm font-medium text-gray-700">Service Date</label>
                        <input type="date" id="serviceDate" name="serviceDate" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2">
                    </div>
                    <div>
                        <label for="technicianName" class="block text-sm font-medium text-gray-700">Technician Name</label>
                        <input type="text" id="technicianName" name="technicianName" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2">
                    </div>
                </div>
            </div>

            <div class="mb-6" id="cctvChecklist" style="display: none;">
                <h2 class="text-xl font-semibold mb-4">CCTV Maintenance Checklist</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div><label><input type="checkbox" name="cctvCamerasLive"> Cameras Live</label></div>
                    <div><label><input type="checkbox" name="cctvPlaybackWorking"> Playback Working</label></div>
                    <div><label><input type="checkbox" name="cctvHddHealthy"> HDD Healthy</label></div>
                    <div><label><input type="checkbox" name="cctvDateTimeAccurate"> Date/Time Accurate</label></div>
                    <div><label><input type="checkbox" name="cctvRemoteAccess"> Remote Access</label></div>
                    <div><label><input type="checkbox" name="cctvPowerSupply"> Power Supply</label></div>
                    <div><label><input type="checkbox" name="cctvLensesClean"> Lenses Clean</label></div>
                    <div><label><input type="checkbox" name="cctvCablesSecure"> Cables Secure</label></div>
                </div>
            </div>

            <div class="mb-6" id="biometricsChecklist" style="display: none;">
                <h2 class="text-xl font-semibold mb-4">Biometrics & Access Control Checklist</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div><label><input type="checkbox" name="biometricsFingerprintScanner"> Fingerprint Scanner Working</label></div>
                    <div><label><input type="checkbox" name="biometricsCardReader"> Card Reader Working</label></div>
                    <div><label><input type="checkbox" name="biometricsDoorLock"> Door Lock Mechanism</label></div>
                    <div><label><input type="checkbox" name="biometricsAccessLogs"> Access Logs Updated</label></div>
                    <div><label><input type="checkbox" name="biometricsUserDatabase"> User Database Backup</label></div>
                    <div><label><input type="checkbox" name="biometricsSensorCalibration"> Sensor Calibration</label></div>
                </div>
            </div>

            <div class="mb-6" id="videoDoorbellChecklist" style="display: none;">
                <h2 class="text-xl font-semibold mb-4">Video Door Bell Checklist</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div><label><input type="checkbox" name="videoDoorbellVideoQuality"> Video Quality Clear</label></div>
                    <div><label><input type="checkbox" name="videoDoorbellAudioQuality"> Audio Quality Clear</label></div>
                    <div><label><input type="checkbox" name="videoDoorbellMotionDetection"> Motion Detection Working</label></div>
                    <div><label><input type="checkbox" name="videoDoorbellNightVision"> Night Vision Working</label></div>
                    <div><label><input type="checkbox" name="videoDoorbellMobileApp"> Mobile App Connectivity</label></div>
                    <div><label><input type="checkbox" name="videoDoorbellChime"> Doorbell Chime Working</label></div>
                </div>
            </div>

            <div class="mb-6" id="fireAlarmChecklist" style="display: none;">
                <h2 class="text-xl font-semibold mb-4">Fire Alarm System Checklist</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div><label><input type="checkbox" name="fireAlarmSmokeDetectors"> Smoke Detectors Working</label></div>
                    <div><label><input type="checkbox" name="fireAlarmHeatDetectors"> Heat Detectors Working</label></div>
                    <div><label><input type="checkbox" name="fireAlarmSounders"> Alarm Sounders Working</label></div>
                    <div><label><input type="checkbox" name="fireAlarmControlPanel"> Control Panel Functional</label></div>
                    <div><label><input type="checkbox" name="fireAlarmBatteryBackup"> Battery Backup Tested</label></div>
                    <div><label><input type="checkbox" name="fireAlarmManualCallPoints"> Manual Call Points Working</label></div>
                </div>
            </div>

            <div class="mb-6">
                <h2 class="text-xl font-semibold mb-4">Issue Description</h2>
                <textarea id="issueDescription" name="issueDescription" rows="4" class="block w-full border-gray-300 rounded-md shadow-sm p-2"></textarea>
            </div>

            <div class="mb-6">
                <h2 class="text-xl font-semibold mb-4">Technician Comments</h2>
                <textarea id="technicianComments" name="technicianComments" rows="4" class="block w-full border-gray-300 rounded-md shadow-sm p-2"></textarea>
            </div>

            <div class="mb-6">
                <h2 class="text-xl font-semibold mb-4">Email Options</h2>
                <div class="flex items-center mb-4">
                    <input type="checkbox" id="sendToCustomer" name="sendToCustomer" class="mr-2">
                    <label for="sendToCustomer" class="text-sm font-medium text-gray-700">Send copy to customer</label>
                </div>
                <p class="text-sm text-gray-600">Admin copy will always be sent to support@eyetechsecurities.in</p>
            </div>

            <div class="flex justify-end space-x-4">
                <button type="button" id="generatePdf" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">Generate PDF Only</button>
                <button type="button" id="generateAndEmail" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Generate PDF & Send Email</button>
            </div>
        </form>
    </div>

    <script>
        document.getElementById('equipmentType').addEventListener('change', function() {
            document.getElementById('cctvChecklist').style.display = this.value === 'CCTV' ? 'block' : 'none';
            document.getElementById('biometricsChecklist').style.display = this.value === 'Biometrics & Access Control' ? 'block' : 'none';
            document.getElementById('videoDoorbellChecklist').style.display = this.value === 'Video Door Bell' ? 'block' : 'none';
            document.getElementById('fireAlarmChecklist').style.display = this.value === 'Fire Alarm' ? 'block' : 'none';
        });

        function generatePDF(sendEmail = false) {
            const form = document.getElementById('serviceReportForm');
            const formData = new FormData(form);
            const reportNumber = 'SR' + Math.floor(1000 + Math.random() * 9000);

            // Ensure all form fields are included, even if empty
            const data = {};
            formData.forEach((value, key) => {
                data[key] = value;
            });
            data.reportNumber = reportNumber;

            // Add default values if fields are missing
            data.customerEmail = data.customerEmail || '';
            data.customerName = data.customerName || '';
            data.serviceDate = data.serviceDate || '';
            data.serviceType = data.serviceType || '';
            data.equipmentType = data.equipmentType || '';
            data.technicianName = data.technicianName || '';
            data.issueDescription = data.issueDescription || '';
            data.technicianComments = data.technicianComments || '';
            data.sendToCustomer = form.querySelector('#sendToCustomer').checked ? 'true' : 'false';

            const checklistHtml = {
                'CCTV': `
                    <h3 class="text-lg font-semibold mb-2">CCTV Maintenance Checklist</h3>
                    <ul class="list-disc pl-5">
                        <li>Cameras Live: ${data.cctvCamerasLive ? '✓' : '✗'}</li>
                        <li>Playback Working: ${data.cctvPlaybackWorking ? '✓' : '✗'}</li>
                        <li>HDD Healthy: ${data.cctvHddHealthy ? '✓' : '✗'}</li>
                        <li>Date/Time Accurate: ${data.cctvDateTimeAccurate ? '✓' : '✗'}</li>
                        <li>Remote Access: ${data.cctvRemoteAccess ? '✓' : '✗'}</li>
                        <li>Power Supply: ${data.cctvPowerSupply ? '✓' : '✗'}</li>
                        <li>Lenses Clean: ${data.cctvLensesClean ? '✓' : '✗'}</li>
                        <li>Cables Secure: ${data.cctvCablesSecure ? '✓' : '✗'}</li>
                    </ul>`,
                'Biometrics & Access Control': `
                    <h3 class="text-lg font-semibold mb-2">Biometrics & Access Control Checklist</h3>
                    <ul class="list-disc pl-5">
                        <li>Fingerprint Scanner Working: ${data.biometricsFingerprintScanner ? '✓' : '✗'}</li>
                        <li>Card Reader Working: ${data.biometricsCardReader ? '✓' : '✗'}</li>
                        <li>Door Lock Mechanism: ${data.biometricsDoorLock ? '✓' : '✗'}</li>
                        <li>Access Logs Updated: ${data.biometricsAccessLogs ? '✓' : '✗'}</li>
                        <li>User Database Backup: ${data.biometricsUserDatabase ? '✓' : '✗'}</li>
                        <li>Sensor Calibration: ${data.biometricsSensorCalibration ? '✓' : '✗'}</li>
                    </ul>`,
                'Video Door Bell': `
                    <h3 class="text-lg font-semibold mb-2">Video Door Bell Checklist</h3>
                    <ul class="list-disc pl-5">
                        <li>Video Quality Clear: ${data.videoDoorbellVideoQuality ? '✓' : '✗'}</li>
                        <li>Audio Quality Clear: ${data.videoDoorbellAudioQuality ? '✓' : '✗'}</li>
                        <li>Motion Detection Working: ${data.videoDoorbellMotionDetection ? '✓' : '✗'}</li>
                        <li>Night Vision Working: ${data.videoDoorbellNightVision ? '✓' : '✗'}</li>
                        <li>Mobile App Connectivity: ${data.videoDoorbellMobileApp ? '✓' : '✗'}</li>
                        <li>Doorbell Chime Working: ${data.videoDoorbellChime ? '✓' : '✗'}</li>
                    </ul>`,
                'Fire Alarm': `
                    <h3 class="text-lg font-semibold mb-2">Fire Alarm System Checklist</h3>
                    <ul class="list-disc pl-5">
                        <li>Smoke Detectors Working: ${data.fireAlarmSmokeDetectors ? '✓' : '✗'}</li>
                        <li>Heat Detectors Working: ${data.fireAlarmHeatDetectors ? '✓' : '✗'}</li>
                        <li>Alarm Sounders Working: ${data.fireAlarmSounders ? '✓' : '✗'}</li>
                        <li>Control Panel Functional: ${data.fireAlarmControlPanel ? '✓' : '✗'}</li>
                        <li>Battery Backup Tested: ${data.fireAlarmBatteryBackup ? '✓' : '✗'}</li>
                        <li>Manual Call Points Working: ${data.fireAlarmManualCallPoints ? '✓' : '✗'}</li>
                    </ul>`
            };

            const pdfContent = `
                <div style="font-family: Arial, sans-serif; padding: 20px;">
                    <h1 style="text-align: center; color: #2563eb;">Eye Tech Securities</h1>
                    <h2 style="text-align: center;">Service Report #${reportNumber}</h2>
                    <hr style="margin: 20px 0;">
                    <h3 class="text-lg font-semibold mb-2">Customer Details</h3>
                    <p><strong>Name:</strong> ${data.customerName}</p>
                    <p><strong>Address:</strong> ${data.customerAddress}</p>
                    <p><strong>Contact Person:</strong> ${data.contactPerson}</p>
                    <p><strong>Contact Number:</strong> ${data.customerContact}</p>
                    <p><strong>Email:</strong> ${data.customerEmail}</p>
                    <hr style="margin: 20px 0;">
                    <h3 class="text-lg font-semibold mb-2">Service Details</h3>
                    <p><strong>Service Type:</strong> ${data.serviceType}</p>
                    <p><strong>Equipment Type:</strong> ${data.equipmentType}</p>
                    <p><strong>Service Date:</strong> ${data.serviceDate}</p>
                    <p><strong>Technician Name:</strong> ${data.technicianName}</p>
                    <hr style="margin: 20px 0;">
                    ${checklistHtml[data.equipmentType] || ''}
                    <hr style="margin: 20px 0;">
                    <h3 class="text-lg font-semibold mb-2">Issue Description</h3>
                    <p>${data.issueDescription || 'No issues reported'}</p>
                    <h3 class="text-lg font-semibold mb-2">Technician Comments</h3>
                    <p>${data.technicianComments || 'No additional comments'}</p>
                </div>
            `;

            const element = document.createElement('div');
            element.innerHTML = pdfContent;

            const opt = {
                margin: 1,
                filename: `Service_Report_${reportNumber}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
            };

            html2pdf().from(element).set(opt).toPdf().get('pdf').then(function (pdf) {
                if (sendEmail) {
                    const pdfBlob = pdf.output('blob');
                    const formDataToSend = new FormData();
                    formDataToSend.append('pdf', pdfBlob, `Service_Report_${reportNumber}.pdf`);
                    formDataToSend.append('customerEmail', data.customerEmail);
                    formDataToSend.append('customerName', data.customerName);
                    formDataToSend.append('reportNumber', reportNumber);
                    formDataToSend.append('serviceDate', data.serviceDate);
                    formDataToSend.append('serviceType', data.serviceType);
                    formDataToSend.append('equipmentType', data.equipmentType);
                    formDataToSend.append('technicianName', data.technicianName);
                    formDataToSend.append('issueDescription', data.issueDescription);
                    formDataToSend.append('technicianComments', data.technicianComments);
                    formDataToSend.append('sendToCustomer', data.sendToCustomer);

                    fetch('/api/send-service-report-email', {
                        method: 'POST',
                        body: formDataToSend
                    })
                    .then(response => response.json())
                    .then(result => {
                        if (result.success) {
                            alert('Service report generated and emails sent successfully!');
                        } else {
                            alert('Error sending emails: ' + result.error);
                        }
                    })
                    .catch(error => {
                        alert('Error sending emails: ' + error.message);
                    });
                } else {
                    html2pdf().from(element).set(opt).save();
                }
            });
        }

        document.getElementById('generatePdf').addEventListener('click', () => generatePDF(false));
        document.getElementById('generateAndEmail').addEventListener('click', () => generatePDF(true));
    </script>
